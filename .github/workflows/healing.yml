name: Self-Healing System

on:
  # Scheduled runs
  schedule:
    # Every 12 hours at 6 AM and 6 PM UTC
    - cron: '0 6,18 * * *'

  # Manual trigger
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no auto-fixes)'
        required: false
        default: 'false'
        type: boolean
      skip_llm:
        description: 'Skip LLM analysis'
        required: false
        default: 'false'
        type: boolean
      projects:
        description: 'Test projects to run (comma-separated)'
        required: false
        default: 'health,contracts,modules'
      max_fixes:
        description: 'Max auto-fixes per run'
        required: false
        default: '3'

  # Run on deployment events
  deployment_status:

env:
  NODE_VERSION: '20'
  BASE_URL: ${{ secrets.STAGING_URL || 'https://react.ecbtx.com' }}
  API_URL: ${{ secrets.API_URL || 'https://react-crm-api-production.up.railway.app' }}

jobs:
  healing:
    name: Self-Healing Run
    timeout-minutes: 30
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Create healing results directory
        run: mkdir -p healing-results

      - name: Run Self-Healing Orchestrator
        id: healing
        run: |
          npx tsx healing/orchestrator.ts \
            ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }} \
            ${{ github.event.inputs.skip_llm == 'true' && '--skip-llm' || '' }} \
            --projects=${{ github.event.inputs.projects || 'health,contracts,modules' }}
        env:
          CI: true
          BASE_URL: ${{ env.BASE_URL }}
          API_URL: ${{ env.API_URL }}
          TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Generate Job Summary
        if: always()
        run: |
          echo "## Self-Healing Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if results file exists
          RESULTS_FILE=$(ls -t healing-results/run-*.json 2>/dev/null | head -1)

          if [ -f "$RESULTS_FILE" ]; then
            echo "### Run Details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Extract key metrics
            RUN_ID=$(jq -r '.runId' "$RESULTS_FILE")
            STATUS=$(jq -r '.overallStatus' "$RESULTS_FILE")
            DURATION=$(jq -r '.duration' "$RESULTS_FILE")
            TESTS_RUN=$(jq -r '.testsRun' "$RESULTS_FILE")
            TESTS_PASSED=$(jq -r '.testsPassed' "$RESULTS_FILE")
            TESTS_FAILED=$(jq -r '.testsFailed' "$RESULTS_FILE")
            FIXES_ATTEMPTED=$(jq -r '.fixesAttempted' "$RESULTS_FILE")
            FIXES_SUCCESSFUL=$(jq -r '.fixesSuccessful' "$RESULTS_FILE")
            LLM_PROVIDER=$(jq -r '.llmProvider' "$RESULTS_FILE")
            LLM_CALLS=$(jq -r '.llmCalls' "$RESULTS_FILE")

            # Status emoji
            if [ "$STATUS" = "healthy" ]; then
              STATUS_EMOJI="âœ…"
            elif [ "$STATUS" = "degraded" ]; then
              STATUS_EMOJI="âš ï¸"
            else
              STATUS_EMOJI="âŒ"
            fi

            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Run ID | \`$RUN_ID\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Status | $STATUS_EMOJI $STATUS |" >> $GITHUB_STEP_SUMMARY
            echo "| Duration | ${DURATION}ms |" >> $GITHUB_STEP_SUMMARY
            echo "| Tests | $TESTS_PASSED/$TESTS_RUN passed |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $TESTS_FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| Fixes | $FIXES_SUCCESSFUL/$FIXES_ATTEMPTED successful |" >> $GITHUB_STEP_SUMMARY
            echo "| LLM | $LLM_PROVIDER ($LLM_CALLS calls) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # List failures if any
            if [ "$TESTS_FAILED" -gt 0 ]; then
              echo "### Failures" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              jq -r '.failures[] | "- **\(.testName)** (\(.category), \(.severity)): \(.errorMessage | .[0:100])..."' "$RESULTS_FILE" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ No results file found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Healing Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: healing-results
          path: healing-results/
          retention-days: 30

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Notify on Critical Failure
        if: failure() && github.event_name == 'schedule'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "ðŸš¨ Self-Healing Run Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ðŸš¨ *Self-Healing Run Failed*\n\nThe scheduled self-healing run encountered critical issues that could not be auto-fixed.\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run Details>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true

  # Optional: Run re-verification after fixes
  verify:
    name: Verify Fixes
    needs: healing
    if: success() && needs.healing.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Re-run health checks
        run: npx playwright test --project=health
        env:
          CI: true
          BASE_URL: ${{ env.BASE_URL }}
          API_URL: ${{ env.API_URL }}
          TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}

      - name: Update Summary
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verification" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Health checks passed after fixes" >> $GITHUB_STEP_SUMMARY
